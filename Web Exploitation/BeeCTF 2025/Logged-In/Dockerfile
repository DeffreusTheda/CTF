FROM php:8.2-apache

RUN a2enmod rewrite
WORKDIR /var/www

COPY public/ public/
COPY documents/ documents/
COPY src/ src/
COPY storage/ storage/
COPY config/php.ini /usr/local/etc/php/conf.d/z-challenge.ini
COPY config/vhost.conf /etc/apache2/sites-available/000-default.conf
COPY flag.txt flag.txt

RUN set -eux; \
    chown -R root:root /var/www; \
    find /var/www -type d -exec chmod 755 {} \; ; \
    find /var/www -type f -exec chmod 644 {} \; ; \
    mkdir -p /var/www/storage/logs /var/log/apache2; \
    touch /var/www/storage/logs/app.log; \
    chown -R www-data:www-data /var/www/storage /var/log/apache2; \
    chmod -R u+rwX,go-rwX /var/www/storage; \
    chown root:root /var/www/flag.txt; \
    chmod 444 /var/www/flag.txt

COPY clear_log.sh /clear_log.sh
COPY entrypoint.sh /entrypoint.sh
RUN sed -i 's/\r$//' /entrypoint.sh /clear_log.sh && chmod +x /entrypoint.sh /clear_log.sh

EXPOSE 80
CMD ["/entrypoint.sh"]
