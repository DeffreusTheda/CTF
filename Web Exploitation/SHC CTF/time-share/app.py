import os
from flask import Flask, request, render_template, redirect, url_for, make_response
import jwt
import datetime
from secrets import token_hex

app = Flask(__name__)

SECRET_KEY = token_hex(16)

users = {
    "user": "spongebob",
    "admin": token_hex(16),
}

FLAG = os.environ.get("FLAG", "SCD{fake_flag_do_not_submit}")


@app.route("/")
def index():
    return render_template("login.html")


@app.route("/login", methods=["POST"])
def login():
    username = request.form.get("username")
    password = request.form.get("password")

    if username in users and users[username] == password:
        token = jwt.encode(
            {
                "username": username,
                "exp": datetime.datetime.utcnow() + datetime.timedelta(minutes=30),
            },
            SECRET_KEY,
            algorithm="HS256",
        )

        response = make_response(redirect(url_for("dashboard")))
        response.set_cookie("auth_token", token)
        return response

    return "Invalid credentials", 401


@app.route("/dashboard")
def dashboard():
    token = request.cookies.get("auth_token")
    try:
        data = jwt.decode(token, SECRET_KEY, algorithms=["HS256"])
        return render_template("user.html", user=data["username"])
    except jwt.ExpiredSignatureError:
        return "Token has expired", 401
    except jwt.InvalidTokenError:
        return "Invalid token", 401


@app.route("/admin")
def admin():
    token = request.cookies.get("admin_token")
    try:
        data = jwt.decode(token, SECRET_KEY, algorithms=["HS256"])
        return render_template("admin.html", admin=data["username"], flag=FLAG)
    except jwt.ExpiredSignatureError:
        return "Token has expired", 401
    except jwt.InvalidTokenError:
        return "Invalid token", 401


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
